        function savePermissions() {
            systemSettings.availabilityOpen = document.getElementById('availabilityOpen').checked;
            systemSettings.statsVisible = document.getElementById('statsVisible').checked;
            
            // Update availability content
            updateAvailabilityContent();
            
            // Update stats visibility
            setupUserInterface();
            
            // Update availability content for current user
            if (currentUser &amp;&amp; currentUser.type === 'חייל') {
                updateAvailabilityContent();
            }
            
            // Update employee dropdown for managers
            updateEmployeeAvailabilityDropdown();
            
            alert('🔐 הרשאות עודכנו בהצלחה!');
            console.log('Permissions saved:', { availabilityOpen: systemSettings.availabilityOpen, statsVisible: systemSettings.statsVisible });
        }

        function updateAvailabilityContent() {
            const availabilityContent = document.getElementById('availabilityContent');
            
            if (!currentUser) return;
            
            if (currentUser.type === 'חייל') {
                if (systemSettings.availabilityOpen) {
                    // Check if user already submitted availability
                    const userAvailability = availabilityData[currentUser.id];
                    const hasSubmitted = userAvailability &amp;&amp; userAvailability.submitted;
                    
                    if (hasSubmitted) {
                        availabilityContent.innerHTML = `
                            <div class="alert alert-success">✅ זמינות נשלחה בהצלחה! תוכל לראות את הזמינות שלך למטה.</div>
<div id="userAvailabilityDisplay"></div>
                        `;
                        displayUserAvailability();
                    } else {
                        availabilityContent.innerHTML = `
                            <div class="alert alert-success">📝 מילוי זמינות פתוח! מלא את הזמינות שלך למשמרות השבוע.</div>
<div class="availability-legend">
<div class="legend-item">
<div class="legend-color" style="background: #d4edda; border-color: #28a745;"></div>
<span>זמין</span>
</div>
<div class="legend-item">
<div class="legend-color" style="background: #f8d7da; border-color: #dc3545;"></div>
<span>לא זמין</span>
</div>
<div class="legend-item">
<div class="legend-color" style="background: #fff3cd; border-color: #ffc107;"></div>
<span>חלקית</span>
</div>
</div>
<div id="employeeAvailabilityForm"></div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" onclick="submitUserAvailability()">📤 שלח זמינות</button>
</div>
                        `;
                        generateEmployeeAvailabilityForm();
                    }
                } else {
                    availabilityContent.innerHTML = '<div class="alert alert-info">מילוי זמינות סגור כרגע. יפתח על ידי המנהל.</div>';
                }
            } else {
                availabilityContent.innerHTML = '<div class="alert alert-info">ניהול זמינות זמין במקטע "ניהול".</div>';
            }
        }

        function generateEmployeeAvailabilityForm() {
            const container = document.getElementById('employeeAvailabilityForm');
            if (!container) return;
            
            let html = '<div class="employee-availability-grid">';
            
            // Empty corner cell
            html += '<div></div>';
            
            // Shift headers
            for (let shift = 0; shift &lt; 4; shift++) {
                html += `<div style="text-align: center; font-weight: 700; color: #667eea; padding: 10px;">
                    ${shiftTypes[shift]}<br/><small>${shiftTimes[shift]}</small>
</div>`;
            }
            
            // Days and availability cells
            for (let day = 0; day &lt; 7; day++) {
                // Day header
                html += `<div class="day-header">${dayNames[day]}</div>`;
                
                // Availability cells for each shift
                for (let shift = 0; shift &lt; 4; shift++) {
                    const cellId = `user_avail_${day}_${shift}`;
                    const currentStatus = getUserAvailabilityStatus(day, shift);
                    
                    html += `<div class="availability-cell ${currentStatus}" id="${cellId}" onclick="toggleAvailability(${day}, ${shift})">
<div class="availability-time">${shiftTypes[shift]}</div>
<div class="availability-status-text" id="${cellId}_text">${getStatusText(currentStatus)}</div>
</div>`;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getUserAvailabilityStatus(day, shift) {
            const userAvailability = availabilityData[currentUser.id];
            if (!userAvailability) return 'available';
            
            if (userAvailability.unavailable) {
                const isUnavailable = userAvailability.unavailable.some(slot =&gt; 
                    slot.day === day &amp;&amp; slot.shift === shift
                );
                if (isUnavailable) return 'unavailable';
            }
            
            if (userAvailability.partial) {
                const isPartial = userAvailability.partial.some(slot =&gt; 
                    slot.day === day &amp;&amp; slot.shift === shift
                );
                if (isPartial) return 'partial';
            }
            
            return 'available';
        }

        function getStatusText(status) {
            switch (status) {
                case 'available': return 'זמין';
                case 'unavailable': return 'לא זמין';
                case 'partial': return 'חלקית';
                default: return 'זמין';
            }
        }

        function toggleAvailability(day, shift) {
            const cellId = `user_avail_${day}_${shift}`;
            const cell = document.getElementById(cellId);
            const textElement = document.getElementById(cellId + '_text');
            
            if (!cell || !textElement) return;
            
            let currentStatus = 'available';
            if (cell.classList.contains('unavailable')) currentStatus = 'unavailable';
            else if (cell.classList.contains('partial')) currentStatus = 'partial';
            
            // Cycle through statuses: available -&gt; partial -&gt; unavailable -&gt; available
            let nextStatus;
            switch (currentStatus) {
                case 'available': nextStatus = 'partial'; break;
                case 'partial': nextStatus = 'unavailable'; break;
                case 'unavailable': nextStatus = 'available'; break;
                default: nextStatus = 'available';
            }
            
            // Update cell appearance
            cell.classList.remove('available', 'partial', 'unavailable');
            cell.classList.add(nextStatus);
            textElement.textContent = getStatusText(nextStatus);
            
            // Update data
            updateUserAvailabilityData(day, shift, nextStatus);
        }

        function updateUserAvailabilityData(day, shift, status) {
            if (!availabilityData[currentUser.id]) {
                availabilityData[currentUser.id] = {
                    unavailable: [],
                    partial: [],
                    submitted: false
                };
            }
            
            const userAvailability = availabilityData[currentUser.id];
            
            // Remove from all arrays
            userAvailability.unavailable = userAvailability.unavailable.filter(slot =&gt; 
                !(slot.day === day &amp;&amp; slot.shift === shift)
            );
            userAvailability.partial = userAvailability.partial.filter(slot =&gt; 
                !(slot.day === day &amp;&amp; slot.shift === shift)
            );
            
            // Add to appropriate array
            if (status === 'unavailable') {
                userAvailability.unavailable.push({ day, shift });
            } else if (status === 'partial') {
                userAvailability.partial.push({ day, shift });
            }
        }

        function submitUserAvailability() {
            if (!currentUser || !availabilityData[currentUser.id]) {
                alert('לא נמצאו נתוני זמינות לשליחה');
                return;
            }
            
            if (!confirm('האם אתה בטוח שברצונך לשלוח את הזמינות? לא ניתן יהיה לערוך אותה לאחר השליחה.')) {
                return;
            }
            
            availabilityData[currentUser.id].submitted = true;
            availabilityData[currentUser.id].submittedAt = new Date().toISOString();
            
            alert('✅ זמינות נשלחה בהצלחה!\nהמנהל יוכל לראות את הזמינות שלך ולהשתמש בה לשיבוץ.');
            
            updateAvailabilityContent();
        }

        function displayUserAvailability() {
            const container = document.getElementById('userAvailabilityDisplay');
            if (!container) return;
            
            const userAvailability = availabilityData[currentUser.id];
            if (!userAvailability) return;
            
            let html = '<h4>הזמינות שלך:</h4>';
            html += '<div class="employee-availability-grid availability-submitted">';
            
            // Empty corner cell
            html += '<div></div>';
            
            // Shift headers
            for (let shift = 0; shift &lt; 4; shift++) {
                html += `<div style="text-align: center; font-weight: 700; color: #667eea; padding: 10px;">
                    ${shiftTypes[shift]}<br/><small>${shiftTimes[shift]}</small>
</div>`;
            }
            
            // Days and availability cells
            for (let day = 0; day &lt; 7; day++) {
                html += `<div class="day-header">${dayNames[day]}</div>`;
                
                for (let shift = 0; shift &lt; 4; shift++) {
                    const status = getUserAvailabilityStatus(day, shift);
                    html += `<div class="availability-cell ${status}">
<div class="availability-time">${shiftTypes[shift]}</div>
<div class="availability-status-text">${getStatusText(status)}</div>
</div>`;
                }
            }
            
            html += '</div>';
            
            if (userAvailability.submittedAt) {
                const submitDate = new Date(userAvailability.submittedAt);
                html += `<p style="text-align: center; color: #28a745; font-weight: 600; margin-top: 10px;">
                    נשלח ב: ${submitDate.toLocaleDateString('he-IL')} ${submitDate.toLocaleTimeString('he-IL')}
                </p>`;
            }
            
            container.innerHTML = html;
        }

        // Management functions for availability
        function loadEmployeeAvailability() {
            const select = document.getElementById('selectedEmployeeForAvailability');
            const managementDiv = document.getElementById('employeeAvailabilityManager');
            const nameDiv = document.getElementById('selectedEmployeeName');
            const statusDiv = document.getElementById('availabilityStatus');
            
            if (!select.value) {
                managementDiv.style.display = 'none';
                return;
            }
            
            const employeeId = parseInt(select.value);
            const employee = users.find(u =&gt; u.id === employeeId);
            
            if (!employee) return;
            
            nameDiv.textContent = `ניהול זמינות עבור: ${employee.firstName} ${employee.lastName}`;
            
            const userAvailability = availabilityData[employeeId];
            if (userAvailability &amp;&amp; userAvailability.submitted) {
                statusDiv.innerHTML = `<div class="alert alert-success">✅ חייל שלח זמינות ב: ${new Date(userAvailability.submittedAt).toLocaleDateString('he-IL')}</div>`;
            } else {
                statusDiv.innerHTML = `<div class="alert alert-warning">⏳ חייל עדיין לא שלח זמינות</div>`;
            }
            
            generateAvailabilityManagementGrid(employeeId);
            managementDiv.style.display = 'block';
        }

        function generateAvailabilityManagementGrid(employeeId) {
            const container = document.getElementById('availabilityManagementGrid');
            if (!container) return;
            
            let html = '<div class="employee-availability-grid">';
            
            // Empty corner cell
            html += '<div></div>';
            
            // Shift headers
            for (let shift = 0; shift &lt; 4; shift++) {
                html += `<div style="text-align: center; font-weight: 700; color: #667eea; padding: 10px;">
                    ${shiftTypes[shift]}<br/><small>${shiftTimes[shift]}</small>
</div>`;
            }
            
            // Days and availability cells
            for (let day = 0; day &lt; 7; day++) {
                html += `<div class="day-header">${dayNames[day]}</div>`;
                
                for (let shift = 0; shift &lt; 4; shift++) {
                    const cellId = `mgmt_avail_${day}_${shift}`;
                    const currentStatus = getEmployeeAvailabilityStatus(employeeId, day, shift);
                    
                    html += `<div class="availability-cell ${currentStatus}" id="${cellId}" onclick="toggleEmployeeAvailability(${employeeId}, ${day}, ${shift})">
<div class="availability-time">${shiftTypes[shift]}</div>
<div class="availability-status-text" id="${cellId}_text">${getStatusText(currentStatus)}</div>
</div>`;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function getEmployeeAvailabilityStatus(employeeId, day, shift) {
            const userAvailability = availabilityData[employeeId];
            if (!userAvailability) return 'available';
            
            if (userAvailability.unavailable) {
                const isUnavailable = userAvailability.unavailable.some(slot =&gt; 
                    slot.day === day &amp;&amp; slot.shift === shift
                );
                if (isUnavailable) return 'unavailable';
            }
            
            if (userAvailability.partial) {
                const isPartial = userAvailability.partial.some(slot =&gt; 
                    slot.day === day &amp;&amp; slot.shift === shift
                );
                if (isPartial) return 'partial';
            }
            
            return 'available';
        }

        function toggleEmployeeAvailability(employeeId, day, shift) {
            const cellId = `mgmt_avail_${day}_${shift}`;
            const cell = document.getElementById(cellId);
            const textElement = document.getElementById(cellId + '_text');
            
            if (!cell || !textElement) return;
            
            let currentStatus = 'available';
            if (cell.classList.contains('unavailable')) currentStatus = 'unavailable';
            else if (cell.classList.contains('partial')) currentStatus = 'partial';
            
            // Cycle through statuses
            let nextStatus;
            switch (currentStatus) {
                case 'available': nextStatus = 'partial'; break;
                case 'partial': nextStatus = 'unavailable'; break;
                case 'unavailable': nextStatus = 'available'; break;
                default: nextStatus = 'available';
            }
            
            // Update cell appearance
            cell.classList.remove('available', 'partial', 'unavailable');
            cell.classList.add(nextStatus);
            textElement.textContent = getStatusText(nextStatus);
            
            // Update data
            updateEmployeeAvailabilityData(employeeId, day, shift, nextStatus);
        }

        function updateEmployeeAvailabilityData(employeeId, day, shift, status) {
            if (!availabilityData[employeeId]) {
                availabilityData[employeeId] = {
                    unavailable: [],
                    partial: [],
                    submitted: false
                };
            }
            
            const userAvailability = availabilityData[employeeId];
            
            // Remove from all arrays
            userAvailability.unavailable = userAvailability.unavailable.filter(slot =&gt; 
                !(slot.day === day &amp;&amp; slot.shift === shift)
            );
            userAvailability.partial = userAvailability.partial.filter(slot =&gt; 
                !(slot.day === day &amp;&amp; slot.shift === shift)
            );
            
            // Add to appropriate array
            if (status === 'unavailable') {
                userAvailability.unavailable.push({ day, shift });
            } else if (status === 'partial') {
                userAvailability.partial.push({ day, shift });
            }
        }

        function saveEmployeeAvailability() {
            const select = document.getElementById('selectedEmployeeForAvailability');
            if (!select.value) {
                alert('לא נבחר חייל');
                return;
            }
            
            const employeeId = parseInt(select.value);
            const employee = users.find(u =&gt; u.id === employeeId);
            
            if (!employee) {
                alert('חייל לא נמצא');
                return;
            }
            
            alert(`✅ זמינות עבור ${employee.firstName} ${employee.lastName} נשמרה בהצלחה!`);
            console.log('Saved availability for employee:', employeeId, availabilityData[employeeId]);
        }

        function clearEmployeeAvailability() {
            const select = document.getElementById('selectedEmployeeForAvailability');
            if (!select.value) {
                alert('לא נבחר חייל');
                return;
            }
            
            const employeeId = parseInt(select.value);
            const employee = users.find(u =&gt; u.id === employeeId);
            
            if (!employee) {
                alert('חייל לא נמצא');
                return;
            }
            
            if (!confirm(`האם אתה בטוח שברצונך לנקות את הזמינות של ${employee.firstName} ${employee.lastName}?`)) {
                return;
            }
            
            // Clear availability data
            availabilityData[employeeId] = {
                unavailable: [],
                partial: [],
                submitted: false
            };
            
            // Regenerate grid
            generateAvailabilityManagementGrid(employeeId);
            
            // Update status
            const statusDiv = document.getElementById('availabilityStatus');
            statusDiv.innerHTML = `<div class="alert alert-warning">⏳ חייל עדיין לא שלח זמינות</div>`;
            
            alert(`🗑️ זמינות עבור ${employee.firstName} ${employee.lastName} נוקתה!`);
        }

        function updateEmployeeAvailabilityDropdown() {
            const select = document.getElementById('selectedEmployeeForAvailability');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">בחר חייל...</option>';
            
            const employees = users.filter(u =&gt; u.type === 'חייל');
            employees.forEach(emp =&gt; {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.firstName} ${emp.lastName}` + (emp.type === 'חייל' ? ' (חייל)' : emp.type === 'מנהל' ? ' (מנהל)' : '');
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }<!DOCTYPE html>

<html dir="rtl" lang="he">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>מערכת ניהול משמרות מתקדמת - שבצק הגמ"ר אלון מורה</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            font-size: 1.2em;
            color: #34495e;
            font-weight: 700;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin: 0 auto;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 3px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
            margin: 8px;
            width: auto;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            width: auto;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: #2c3e50;
            font-weight: 700;
        }

        .dashboard {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 700;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 3px solid #e1e8ed;
            margin-bottom: 25px;
            flex-wrap: wrap;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 5px;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            color: #7f8c8d;
            transition: all 0.3s;
            border-radius: 8px;
            margin: 2px;
        }

        .nav-tab.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            font-size: 12px;
        }

        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 6px;
            font-weight: 700;
            text-align: center;
            font-size: 11px;
        }

        .schedule-table td {
            padding: 8px 4px;
            border: 2px solid #e1e8ed;
            text-align: center;
            font-weight: 600;
            min-height: 50px;
            vertical-align: middle;
            font-size: 10px;
        }

        .shift-cell {
            background: #f8f9fa;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 45px;
            border: 2px solid #dee2e6;
        }

        .shift-cell:hover {
            background: #e3f2fd;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .shift-cell.assigned {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: #2c3e50;
            font-weight: 700;
        }

        .shift-cell.night {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }

        .shift-cell.personal {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            color: #2c3e50;
            font-weight: 700;
        }

        .shift-cell.holiday {
            background: linear-gradient(135deg, #b3e5fc 0%, #e1f5fe 100%) !important;
            color: #01579b;
            font-weight: 700;
        }

        .shift-cell.shabbat {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%) !important;
            color: #880e4f;
            font-weight: 700;
        }

        .shift-cell.my-shift {
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%) !important;
            color: #f57f17;
            font-weight: 700;
            border: 3px solid #fbc02d !important;
            box-shadow: 0 0 10px rgba(251, 192, 45, 0.3);
        }

        .role-sg {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
            font-weight: 700;
            color: #1565c0;
        }

        .role-patrol {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%) !important;
            font-weight: 700;
            color: #ef6c00;
        }

        .role-patrol-4h {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
            font-weight: 700;
            color: #7b1fa2;
        }

        .user-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .user-list {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 15px;
            background: #f8f9fa;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 2px solid #e1e8ed;
            background: white;
            margin-bottom: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .user-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .user-info-item {
            flex-grow: 1;
        }

        .user-name {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .user-details {
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: 600;
        }

        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-weight: 700;
            border: 2px solid;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-color: #f5c6cb;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-color: #bee5eb;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-color: #ffeaa7;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .settings-panel {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .availability-cell {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .availability-cell:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .availability-cell.available {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-color: #28a745;
            color: #155724;
        }

        .availability-cell.unavailable {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #dc3545;
            color: #721c24;
        }

        .availability-cell.partial {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffc107;
            color: #856404;
        }

        .availability-time {
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .availability-status-text {
            font-size: 0.7em;
            font-weight: 700;
        }

        .employee-availability-grid {
            display: grid;
            grid-template-columns: auto repeat(4, 1fr);
            gap: 8px;
            margin: 20px 0;
            max-width: 100%;
            overflow-x: auto;
        }

        .day-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-weight: 700;
            text-align: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .availability-submitted {
            opacity: 0.7;
            pointer-events: none;
        }

        .availability-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #dee2e6;
        }

        .hebrew-date {
            font-weight: 700;
            color: #7b1fa2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 900;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            font-weight: 700;
            color: #2c3e50;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 8px;
            transform: scale(1.2);
        }

        .checkbox-group label {
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .range-container input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
        }

        .range-value {
            min-width: 40px;
            text-align: center;
            font-weight: 700;
            color: #667eea;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .nav-tab {
                flex-shrink: 0;
                font-size: 14px;
                padding: 12px 18px;
            }
            
            .user-form {
                grid-template-columns: 1fr;
            }

            .schedule-table {
                font-size: 10px;
            }

            .schedule-table th {
                padding: 8px 4px;
                font-size: 9px;
            }

            .schedule-table td {
                padding: 6px 2px;
                font-size: 8px;
            }

            .availability-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
<div class="container">
<div class="header">
<h1>🚀 מערכת ניהול משמרות מתקדמת</h1>
<p class="subtitle">שבצק הגמ"ר אלון מורה</p>
</div>
<!-- Login Form -->
<div class="login-form" id="loginForm">
<h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50; font-weight: 700;">כניסה למערכת</h2>
<div class="form-group">
<label>בחר משתמש מוכן או כניסה ידנית:</label>
<select id="quickLogin" onchange="handleQuickLogin()">
<option value="">בחר משתמש...</option>
<option value="admin">מנהל כללי</option>
<option value="manual">כניסה ידנית</option>
</select>
</div>
<div id="manualLogin" style="display: none;">
<div class="form-group">
<label>סוג משתמש:</label>
<select id="userType" onchange="togglePassword()">
<option value="חייל">חייל</option>
<option value="viewer">צופה</option>
<option value="מנהל">מנהל</option>
<option value="admin">מנהל כללי</option>
</select>
</div>
<div class="form-group">
<label>שם פרטי:</label>
<input id="firstName" placeholder="הכנס שם פרטי" type="text"/>
</div>
<div class="form-group">
<label>שם משפחה:</label>
<input id="lastName" placeholder="הכנס שם משפחה" type="text"/>
</div>
<div class="form-group">
<label>מספר טלפון:</label>
<input id="phone" placeholder="הכנס מספר טלפון" type="tel"/>
</div>
<div class="form-group" id="passwordGroup">
<label>סיסמה:</label>
<input id="password" placeholder="הכנס סיסמה" type="password"/>
</div>
<div class="checkbox-group">
<input id="rememberMe" type="checkbox"/>
<label for="rememberMe">זכור אותי</label>
</div>
</div>
<button class="btn" onclick="performLogin()">כניסה למערכת</button>
</div>
<!-- Dashboard -->
<div class="dashboard" id="dashboard">
<button class="logout-btn" onclick="performLogout()">יציאה</button>
<div class="user-info" id="userInfoDisplay"></div>
<div class="nav-tabs">
<button class="nav-tab active" onclick="showTab('schedule')">📅 לוח משמרות</button>
<button class="nav-tab" id="availabilityTabBtn" onclick="showTab('availability')" style="display: none;">⏰ זמינות</button>
<button class="nav-tab" id="statsTabBtn" onclick="showTab('stats')" style="display: none;">📊 סטטיסטיקות</button>
<button class="nav-tab" id="managementTabBtn" onclick="showTab('management')" style="display: none;">⚙️ ניהול</button>
<button class="nav-tab" id="reportsTabBtn" onclick="showTab('reports')" style="display: none;">📋 דוחות</button>
<button class="nav-tab" id="settingsTabBtn" onclick="showTab('settings')" style="display: none;">🔧 הגדרות</button>
</div>
<!-- Schedule Tab -->
<div class="tab-content active" id="scheduleTab">
<h2>📅 לוח משמרות שבועי</h2>
<div id="scheduleContent">
<div id="managerButtons" style="margin-bottom: 15px; display: none;">
<button class="btn btn-secondary" onclick="generateAutoSchedule()">🎯 שיבוץ אוטומטי חכם</button>
<button class="btn btn-secondary" onclick="clearAllSchedule()">🗑️ נקה לוח</button>
<button class="btn btn-secondary" onclick="exportSchedule()">📤 יצוא לאקסל</button>
</div>
<div id="scheduleTableContainer"></div>
</div>
</div>
<!-- Availability Tab -->
<div class="tab-content" id="availabilityTab">
<h2>⏰ זמינות למשמרות</h2>
<div id="availabilityContent">
<div class="alert alert-info">מילוי זמינות סגור כרגע. יפתח על ידי המנהל.</div>
</div>
</div>
<!-- Stats Tab -->
<div class="tab-content" id="statsTab">
<h2>📊 סטטיסטיקות מתקדמות</h2>
<div class="stats-grid" id="statsGrid"></div>
</div>
<!-- Management Tab -->
<div class="tab-content" id="managementTab">
<h2>⚙️ ניהול המערכת</h2>
<div class="settings-panel">
<h3>👥 הוספת משתמשים</h3>
<div class="user-form">
<input id="newUserFirst" placeholder="שם פרטי" type="text"/>
<input id="newUserLast" placeholder="שם משפחה" type="text"/>
<input id="newUserPhone" placeholder="מספר טלפון" type="tel"/>
<input id="newUserEmail" placeholder="אימייל (אופציונלי)" type="email"/>
<select id="newUserType" onchange="toggleNewUserPassword()">
<option value="חייל">חייל</option>
<option value="viewer">צופה</option>
<option value="מנהל">מנהל</option>
</select>
<input id="newUserPassword" placeholder="סיסמה (חובה למנהלים)" style="display: none;" type="password"/>
<button class="btn btn-secondary" onclick="addNewUser()">הוסף משתמש</button>
</div>
</div>
<div class="settings-panel">
<h3>📅 ניהול זמינות חיילים</h3>
<div class="form-group hidden">
<label>בחר חייל לניהול זמינות:</label>
<select id="selectedEmployeeForAvailability" onchange="loadEmployeeAvailability()">
<option value="">בחר חייל...</option>
</select>
</div>
<div class="settings-panel">
<h3>📈 התקדמות מילוי זמינות</h3>
<div class="progress-bar">
<div class="progress-fill" id="availabilityProgressFill" style="width: 0%;"></div>
</div>
<p id="availabilityProgressText" style="text-align: center; font-weight: 600;">0% השלימו</p>
</div>
<div id="employeeAvailabilityManager" style="display: none;">
<h4 id="selectedEmployeeName" style="color: #667eea; margin: 15px 0;"></h4>
<div class="availability-status" style="margin-bottom: 20px;">
<div class="alert alert-info" id="availabilityStatus">סטטוס זמינות יוצג כאן</div>
</div>
<div class="availability-grid" id="availabilityManagementGrid">
<!-- Grid will be generated by JavaScript -->
</div>
<div style="margin-top: 20px; text-align: center;">
<button class="btn btn-success" onclick="saveEmployeeAvailability()">💾 שמור זמינות</button>
<button class="btn btn-secondary" onclick="clearEmployeeAvailability()">🗑️ נקה זמינות</button>
</div>
</div>
</div>
<div>
<h3>📋 רשימת משתמשים</h3>
<h4 style="margin-top:20px;">📋 טבלת חיילים שנוספו</h4>
<table border="1" id="soldierTable" style="width:100%; text-align:center; border-collapse: collapse; margin-bottom: 20px;">
<thead>
<tr><th>#</th><th>שם פרטי</th><th>שם משפחה</th></tr>
</thead>
<tbody></tbody>
</table>

<div id="soldierCountDisplay" style="margin: 10px 0; font-weight: bold;">חיילים במערכת: 0</div>
<div class="user-list" id="usersList">
<div class="alert alert-info">רק המנהל הכללי קיים במערכת. הוסף משתמשים כדי להתחיל.</div>
</div>
</div>
</div>
<!-- Reports Tab -->
<div class="tab-content" id="reportsTab">
<h2>📋 דוחות מתקדמים</h2>
<div class="alert alert-info">אין נתונים להצגה</div>
</div>
<!-- Settings Tab -->
<div class="tab-content" id="settingsTab">
<h2>🔧 הגדרות מערכת</h2>
<div class="settings-panel">
<h3>⚙️ הגדרות שיבוץ אוטומטי</h3>
<div class="settings-grid">
<div class="form-group">
<label>מספר חיילים לשיבוץ:</label>
<div class="range-container">
<input id="maxEmployeesToSchedule" max="20" min="1" oninput="updateRangeValue('maxEmployeesToSchedule', this.value)" type="range" value="0"/>
<div class="range-value" id="maxEmployeesToScheduleValue">0</div>
</div>
<small>0 = כל החיילים</small>
</div>
<div class="form-group">
<label>משמרות 6 שעות לחייל:</label>
<div class="range-container">
<input disabled="" id="shiftsPerEmployee" max="6" min="6" oninput="updateRangeValue('shiftsPerEmployee', this.value)" type="range" value="6"/>
<div class="range-value" id="shiftsPerEmployeeValue">6</div>
</div>
<small style="color: #28a745; font-weight: 600;">קבוע: 6 משמרות לכל חייל</small>
</div>
<div class="form-group">
<label>משמרות 4 שעות לחייל:</label>
<div class="range-container">
<input disabled="" id="shortShiftsPerEmployee" max="1" min="1" oninput="updateRangeValue('shortShiftsPerEmployee', this.value)" type="range" value="1"/>
<div class="range-value" id="shortShiftsPerEmployeeValue">1</div>
</div>
<small style="color: #28a745; font-weight: 600;">קבוע: משמרת אחת לכל חייל</small>
</div>
<div class="form-group">
<label>מקסימום משמרות לילה:</label>
<div class="range-container">
<input id="maxNightShifts" max="5" min="0" oninput="updateRangeValue('maxNightShifts', this.value)" type="range" value="2"/>
<div class="range-value" id="maxNightShiftsValue">2</div>
</div>
</div>
<div class="form-group">
<label>סדר עדיפות שיבוץ:</label>
<select id="assignmentPriority">
<option value="sg_first">ש.ג קודם</option>
<option value="patrol_first">סיור קודם</option>
<option value="balanced">מאוזן</option>
</select>
</div>
<div class="form-group">
<div class="checkbox-group">
<input checked="" id="preventConsecutive" type="checkbox"/>
<label for="preventConsecutive">מנע משמרות רצופות</label>
</div>
</div>
</div>
<button class="btn btn-success" onclick="saveSettings()">💾 שמור הגדרות</button>
</div>
<div class="settings-panel">
<h3>📆 קביעת פתיחת זמינות לפי יום ושעה</h3>
<div class="form-group">
<label for="availabilityDay">יום בשבוע:</label>
<select id="availabilityDay">
<option value="0">ראשון</option>
<option value="1">שני</option>
<option value="2">שלישי</option>
<option value="3">רביעי</option>
<option value="4">חמישי</option>
<option value="5">שישי</option>
<option value="6">שבת</option>
</select>
</div>
<div class="form-group">
<label for="availabilityHour">שעה:</label>
<input id="availabilityHour" type="time" value="08:00"/>
</div>
<button class="btn btn-success" onclick="scheduleAvailabilityOpening()">🕓 קבע פתיחה עתידית</button>
<p id="availabilityScheduleInfo" style="text-align: center; font-weight: 600; margin-top: 10px;"></p>
</div>
<div class="settings-panel">
<h3>👥 הרשאות משתמשים</h3>
<div class="checkbox-group">
<input id="availabilityOpen" type="checkbox"/>
<label for="availabilityOpen">פתח מילוי זמינות לחיילים</label>
</div>
<div class="checkbox-group">
<input checked="" id="statsVisible" type="checkbox"/>
<label for="statsVisible">הצג סטטיסטיקות למנהלים</label>
</div>
<button class="btn btn-success" onclick="savePermissions()">💾 שמור הרשאות</button>
</div>
</div>
</div>
</div>
<script>
        // Global variables
        let currentUser = null;
        let users = [{
            id: 1,
            firstName: 'מנהל',
            lastName: 'כללי',
            phone: '0585123770',
            email: 'admin@example.com',
            type: 'admin',
            password: '322770',
            rememberMe: false
        }];
        let scheduleData = {};
        let availabilityData = {};
        let systemSettings = {
            maxEmployeesToSchedule: 0,
            shiftsPerEmployee: 6,
            shortShiftsPerEmployee: 1,
            availabilityOpen: false,
            assignmentPriority: 'sg_first',
            preventConsecutive: true,
            maxNightShifts: 2,
            statsVisible: true
        };

        // Hebrew calendar data
        const hebrewNumerals = {
            1: 'א\'', 2: 'ב\'', 3: 'ג\'', 4: 'ד\'', 5: 'ה\'', 6: 'ו\'', 7: 'ז\'', 8: 'ח\'', 9: 'ט\'', 10: 'י\'',
            11: 'י"א', 12: 'י"ב', 13: 'י"ג', 14: 'י"ד', 15: 'ט"ו', 16: 'ט"ז', 17: 'י"ז', 18: 'י"ח', 19: 'י"ט', 20: 'כ\'',
            21: 'כ"א', 22: 'כ"ב', 23: 'כ"ג', 24: 'כ"ד', 25: 'כ"ה', 26: 'כ"ו', 27: 'כ"ז', 28: 'כ"ח', 29: 'כ"ט', 30: 'ל\''
        };

        const hebrewMonths = ['תשרי', 'חשון', 'כסלו', 'טבת', 'שבט', 'אדר', 'ניסן', 'אייר', 'סיון', 'תמוז', 'אב', 'אלול'];
        const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        const shiftTypes = ['לילה', 'בוקר', 'צהרים', 'ערב'];
        const shiftTimes = ['01:00-07:00', '07:00-13:00', '13:00-19:00', '19:00-01:00'];

        // Jewish holidays
        const jewishHolidays = {
            '2025-09-15': 'ראש השנה א\'',
            '2025-09-16': 'ראש השנה ב\'',
            '2025-09-24': 'יום כיפור',
            '2025-09-29': 'סוכות',
            '2025-10-06': 'שמחת תורה',
            '2025-12-25': 'חנוכה א\'',
            '2025-03-14': 'פורים',
            '2025-03-15': 'שושן פורים',
            '2025-04-13': 'פסח',
            '2025-05-02': 'יום העצמאות',
            '2025-06-01': 'שבועות'
        };

        // Login Functions
        function performLogin() {
            try {
                const quickLogin = document.getElementById('quickLogin').value;
                console.log('Login attempt:', quickLogin);
                
                if (quickLogin === 'admin') {
                    const password = prompt('הכנס סיסמה עבור המנהל הכללי:');
                    
                    if (!password) {
                        alert('נדרשת סיסמה לכניסה');
                        return;
                    }
                    
                    if (password !== '322770') {
                        alert('סיסמה שגויה');
                        return;
                    }
                    
                    const adminUser = users.find(u => u.type === 'admin');
                    if (!adminUser) {
                        alert('שגיאה: לא נמצא משתמש מנהל במערכת');
                        return;
                    }
                    
                    currentUser = adminUser;
                    showDashboard();
                    setupUserInterface();
                    return;
                    
                } else if (quickLogin.startsWith('user_')) {
                    const userId = parseInt(quickLogin.replace('user_', ''));
                    const selectedUser = users.find(u => u.id === userId);
                    
                    if (!selectedUser) {
                        alert('משתמש לא נמצא');
                        return;
                    }
                    
                    if ((selectedUser.type === 'admin' || selectedUser.type === 'מנהל') && selectedUser.password) {
                        const password = prompt(`הכנס סיסמה עבור ${selectedUser.firstName} ${selectedUser.lastName}:`);
                        if (!password) {
                            alert('נדרשת סיסמה לכניסה');
                            return;
                        }
                        if (password !== selectedUser.password) {
                            alert('סיסמה שגויה');
                            return;
                        }
                    }
                    
                    currentUser = selectedUser;
                    showDashboard();
                    setupUserInterface();
                    return;
                    
                } else if (quickLogin === 'manual') {
                    const firstName = document.getElementById('firstName').value.trim();
                    const lastName = document.getElementById('lastName').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    const password = document.getElementById('password').value;
                    const userType = document.getElementById('userType').value;

                    if (!firstName || !lastName || !phone) {
                        alert('יש למלא את כל השדות הנדרשים');
                        return;
                    }

                    if ((userType === 'admin' || userType === 'מנהל') && !password) {
                        alert('נדרשת סיסמה למנהלים');
                        return;
                    }

                    let existingUser = users.find(u => u.phone === phone);
                    
                    if (existingUser) {
                        if ((existingUser.type === 'admin' || existingUser.type === 'מנהל') && existingUser.password && existingUser.password !== password) {
                            alert('סיסמה שגויה');
                            return;
                        }
                        currentUser = existingUser;
                    } else {
                        currentUser = {
                            id: Date.now(),
                            firstName,
                            lastName,
                            phone,
                            type: userType,
                            password: password || ''
                        };
                        users.push(currentUser);
                    }

                    showDashboard();
                    setupUserInterface();
                    return;
                } else {
                    alert('יש לבחור סוג כניסה');
                    return;
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('שגיאה בכניסה: ' + error.message);
            }
        }

        function performLogout() {
            currentUser = null;
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            
            document.getElementById('quickLogin').value = '';
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('password').value = '';
            document.getElementById('userType').value = 'חייל';
            document.getElementById('rememberMe').checked = false;
            document.getElementById('manualLogin').style.display = 'none';
            
            showTab('schedule');
        }

        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            const clickedTab = Array.from(navTabs).find(tab => 
                tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(tabName)
            );
            if (clickedTab) {
                clickedTab.classList.add('active');
            }

            if (tabName === 'stats') updateStats();
            if (tabName === 'settings') updateSettingsDisplay();
            if (tabName === 'management' && currentUser && currentUser.type === 'admin') {
        updateAvailabilityProgress();
                updateEmployeeAvailabilityDropdown();
            }
        }

        function handleQuickLogin() {
            const quickLogin = document.getElementById('quickLogin');
            const manualLogin = document.getElementById('manualLogin');
            
            if (quickLogin.value === 'manual') {
                manualLogin.style.display = 'block';
                togglePassword();
            } else {
                manualLogin.style.display = 'none';
            }
        }

        function togglePassword() {
            const userType = document.getElementById('userType').value;
            const passwordGroup = document.getElementById('passwordGroup');
            
            if (userType === 'admin' || userType === 'מנהל') {
                passwordGroup.style.display = 'block';
            } else {
                passwordGroup.style.display = 'none';
            }
        }

        function toggleNewUserPassword() {
            const userType = document.getElementById('newUserType').value;
            const passwordField = document.getElementById('newUserPassword');
            
            if (userType === 'admin' || userType === 'מנהל') {
                passwordField.style.display = 'block';
                passwordField.placeholder = 'סיסמה (חובה למנהלים)';
                passwordField.setAttribute('required', 'required');
            } else {
                passwordField.style.display = 'none';
                passwordField.removeAttribute('required');
            }
        }

        // User Management
        function addNewUser() {
            const firstName = document.getElementById('newUserFirst').value.trim();
            const lastName = document.getElementById('newUserLast').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const type = document.getElementById('newUserType').value;
            const password = document.getElementById('newUserPassword').value;

            if (!firstName || !lastName || !phone) {
                alert('יש למלא את כל השדות הנדרשים');
                return;
            }

            if ((type === 'admin' || type === 'מנהל') && !password) {
                alert('נדרשת סיסמה למנהלים');
                return;
            }

            if (users.find(u => u.phone === phone)) {
                alert('משתמש עם מספר טלפון זה כבר קיים');
                return;
            }

            const newUser = {
                id: Date.now(),
                firstName,
                lastName,
                phone,
                email,
                type,
                password: password || ''
            };

            users.push(newUser);
    populateSoldierTable();
            updateUsersList();
            updateQuickLoginOptions();
            updateEmployeeAvailabilityDropdown();

            document.getElementById('newUserFirst').value = '';
            document.getElementById('newUserLast').value = '';
            document.getElementById('newUserPhone').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPassword').value = '';

            const typeText = {
                'חייל': 'חייל',
                'viewer': 'צופה',
                'מנהל': 'מנהל',
                'admin': 'מנהל כללי'
            };

            alert(`${typeText[type]} נוסף בהצלחה!${(type === 'admin' || type === 'מנהל') ? '\nהסיסמה נשמרה במערכת.' : ''}`);
        }

        function removeUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            if (confirm(`האם אתה בטוח שברצונך להסיר את ${user.firstName} ${user.lastName}?`)) {
                users = users.filter(u => u.id !== id);
                updateUsersList();
                updateQuickLoginOptions();
                alert('משתמש הוסר בהצלחה');
            }
        }

        // Schedule Management
        function generateAutoSchedule() {
            if (currentUser.type !== 'admin' && currentUser.type !== 'מנהל') {
                alert('אין לך הרשאה לבצע שיבוץ אוטומטי');
                return;
            }

            const employees = users.filter(u => u.type === 'חייל');
            if (employees.length === 0) {
                alert('אין חיילים במערכת לשיבוץ');
                return;
            }

            if (!confirm('האם לבצע שיבוץ אוטומטי חכם? פעולה זו תמחק את השיבוץ הנוכחי ותבסס על ההגדרות הנוכחיות.')) {
                return;
            }

            console.log('🎯 מתחיל שיבוץ אוטומטי חכם עם הגדרות מותאמות');
            console.log('Settings:', systemSettings);

            // Clear existing schedule
            scheduleData = {};
            document.querySelectorAll('.shift-cell').forEach(cell => {
                cell.innerHTML = '';
                cell.classList.remove('assigned', 'personal', 'my-shift');
            });

            // Use settings
            const maxEmployees = systemSettings.maxEmployeesToSchedule || employees.length;
            const regularShiftsPerEmployee = systemSettings.shiftsPerEmployee;
            const shortShiftsPerEmployee = systemSettings.shortShiftsPerEmployee;
            const selectedEmployees = employees.slice(0, maxEmployees);
            
            const employeeTracker = {};
            selectedEmployees.forEach(emp => {
                employeeTracker[emp.id] = {
                    employee: emp,
                    regularShifts: 0,
                    shortShifts: 0,
                    nightShifts: 0,
                    lastAssignedDay: -2,
                    assignedDays: new Set()
                };
            });

            console.log(`📊 חיילים לשיבוץ: ${selectedEmployees.length}`);
            console.log(`📊 משמרות 6 שעות לחייל: ${regularShiftsPerEmployee}`);
            console.log(`📊 משמרות 4 שעות לחייל: ${shortShiftsPerEmployee}`);

            // Assignment based on priority
            if (systemSettings.assignmentPriority === 'sg_first') {
                assignSGShiftsFirst(selectedEmployees, employeeTracker, regularShiftsPerEmployee);
                assignPatrolShifts(selectedEmployees, employeeTracker, regularShiftsPerEmployee);
                assignShortShifts(selectedEmployees, employeeTracker, shortShiftsPerEmployee);
            } else if (systemSettings.assignmentPriority === 'patrol_first') {
                assignPatrolShifts(selectedEmployees, employeeTracker, regularShiftsPerEmployee);
                assignSGShiftsFirst(selectedEmployees, employeeTracker, regularShiftsPerEmployee);
                assignShortShifts(selectedEmployees, employeeTracker, shortShiftsPerEmployee);
            } else { // balanced
                assignBalancedShifts(selectedEmployees, employeeTracker, regularShiftsPerEmployee, shortShiftsPerEmployee);
            }

            const summary = generateScheduleSummary(employeeTracker);
            console.log('📊 סיכום שיבוץ:', summary);
            
            alert(`🎯 שיבוץ אוטומטי הושלם בהצלחה!\n\n` +
                  `✅ משמרות ש.ג: ${summary.sgShifts}\n` +
                  `✅ משמרות סייר 6 שעות: ${summary.patrolShifts}\n` +
                  `✅ משמרות סייר 4 שעות: ${summary.shortShifts}\n\n` +
                  `👥 חיילים שובצו: ${summary.assignedEmployees}/${selectedEmployees.length}\n` +
                  `📈 אחוז כיסוי: ${summary.coveragePercent}%\n` +
                  `🌙 ממוצע לילות לחייל: ${(summary.totalNightShifts / selectedEmployees.length).toFixed(1)}`);
            
            updateStats();
            
            setTimeout(() => {
                highlightMyShifts();
            }, 100);
        }

        function assignShiftToEmployee(cellId, employee, tracker, day, isShortShift = false, isNightShift = false) {
            const cell = document.getElementById(cellId);
            if (cell) {
                scheduleData[cellId] = `${employee.firstName} ${employee.lastName}`;
                cell.innerHTML = `${employee.firstName}<br>${employee.lastName}`;
                cell.classList.add('assigned');
                
                if (currentUser && `${currentUser.firstName} ${currentUser.lastName}` === `${employee.firstName} ${employee.lastName}`) {
                    cell.classList.add('my-shift');
                }
                
                if (isShortShift) {
                    tracker.shortShifts++;
                } else {
                    tracker.regularShifts++;
                }
                
                if (isNightShift) {
                    tracker.nightShifts++;
                }
                
                tracker.lastAssignedDay = day;
                tracker.assignedDays.add(day);
            }
        }

        function assignSGShiftsFirst(selectedEmployees, employeeTracker, maxRegularShifts) {
            console.log('🎯 שלב 1: שיבוץ משמרות ש.ג');
            
            const sgShifts = [];
            for (let day = 0; day < 7; day++) {
                for (let shift = 0; shift < 4; shift++) {
                    sgShifts.push({ 
                        day, 
                        shift, 
                        cellId: `ש.ג_${day}_${shift}`,
                        type: 'sg',
                        isNight: shift === 0
                    });
                }
            }

            sgShifts.sort(() => Math.random() - 0.5);

            sgShifts.forEach(shiftSlot => {
                const availableEmployees = selectedEmployees.filter(emp => {
                    const tracker = employeeTracker[emp.id];
                    
                    if (tracker.regularShifts >= maxRegularShifts) return false;
                    if (tracker.assignedDays.has(shiftSlot.day)) return false;
                    if (systemSettings.preventConsecutive && Math.abs(tracker.lastAssignedDay - shiftSlot.day) <= 1 && tracker.lastAssignedDay !== -2) return false;
                    if (shiftSlot.isNight && tracker.nightShifts >= systemSettings.maxNightShifts) return false;
                    
                    const empAvailability = availabilityData[emp.id];
                    if (empAvailability && empAvailability.unavailable) {
                        const isUnavailable = empAvailability.unavailable.some(slot => 
                            slot.day === shiftSlot.day && slot.shift === shiftSlot.shift
                        );
                        if (isUnavailable) return false;
                    }
                    
                    return true;
                });

                if (availableEmployees.length > 0) {
                    const selectedEmp = availableEmployees.reduce((prev, current) => {
                        const prevTracker = employeeTracker[prev.id];
                        const currentTracker = employeeTracker[current.id];
                        if (prevTracker.regularShifts !== currentTracker.regularShifts) {
                            return prevTracker.regularShifts < currentTracker.regularShifts ? prev : current;
                        }
                        return prevTracker.nightShifts < currentTracker.nightShifts ? prev : current;
                    });
                    
                    assignShiftToEmployee(shiftSlot.cellId, selectedEmp, employeeTracker[selectedEmp.id], shiftSlot.day, false, shiftSlot.isNight);
                }
            });
        }

        function assignPatrolShifts(selectedEmployees, employeeTracker, maxRegularShifts) {
            console.log('🎯 שלב 2: השלמת משמרות עם סייר 6 שעות');
            
            selectedEmployees.forEach(emp => {
                const tracker = employeeTracker[emp.id];
                
                while (tracker.regularShifts < maxRegularShifts) {
                    const availablePatrolShifts = [];
                    
                    for (let day = 0; day < 7; day++) {
                        if (tracker.assignedDays.has(day)) continue;
                        if (systemSettings.preventConsecutive && Math.abs(tracker.lastAssignedDay - day) <= 1 && tracker.lastAssignedDay !== -2) continue;
                        
                        for (let shift = 0; shift < 4; shift++) {
                            const cellId = `סייר6שעות_${day}_${shift}`;
                            if (scheduleData[cellId]) continue;
                            
                            const isNight = shift === 0;
                            if (isNight && tracker.nightShifts >= systemSettings.maxNightShifts) continue;
                            
                            const empAvailability = availabilityData[emp.id];
                            if (empAvailability && empAvailability.unavailable) {
                                const isUnavailable = empAvailability.unavailable.some(slot => 
                                    slot.day === day && slot.shift === shift
                                );
                                if (isUnavailable) continue;
                            }
                            
                            availablePatrolShifts.push({ day, shift, cellId, isNight });
                        }
                    }

                    if (availablePatrolShifts.length > 0) {
                        const randomShift = availablePatrolShifts[Math.floor(Math.random() * availablePatrolShifts.length)];
                        assignShiftToEmployee(randomShift.cellId, emp, tracker, randomShift.day, false, randomShift.isNight);
                    } else {
                        break;
                    }
                }
            });
        }

        function assignShortShifts(selectedEmployees, employeeTracker, maxShortShifts) {
            console.log('🎯 שלב 3: שיבוץ משמרות 4 שעות');
            
            selectedEmployees.forEach(emp => {
                const tracker = employeeTracker[emp.id];
                
                for (let i = 0; i < maxShortShifts; i++) {
                    if (tracker.shortShifts >= maxShortShifts) break;
                    
                    const available4hShifts = [];
                    
                    for (let day = 0; day < 7; day++) {
                        const cellId = `סייר4שעות_${day}_all`;
                        if (scheduleData[cellId]) continue;
                        if (tracker.assignedDays.has(day)) continue;
                        
                        available4hShifts.push({ day, cellId });
                    }

                    if (available4hShifts.length > 0) {
                        const randomShift = available4hShifts[Math.floor(Math.random() * available4hShifts.length)];
                        assignShiftToEmployee(randomShift.cellId, emp, tracker, randomShift.day, true, false);
                    }
                }
            });
        }

        function assignBalancedShifts(selectedEmployees, employeeTracker, maxRegularShifts, maxShortShifts) {
            console.log('🎯 שיבוץ מאוזן: מחלק משמרות בצורה שווה');
            
            const allShifts = [];
            
            // Add SG shifts
            for (let day = 0; day < 7; day++) {
                for (let shift = 0; shift < 4; shift++) {
                    allShifts.push({ 
                        day, 
                        shift, 
                        cellId: `ש.ג_${day}_${shift}`,
                        type: 'sg',
                        isNight: shift === 0,
                        hours: 6
                    });
                }
            }
            
            // Add patrol 6 hour shifts
            for (let day = 0; day < 7; day++) {
                for (let shift = 0; shift < 4; shift++) {
                    allShifts.push({ 
                        day, 
                        shift, 
                        cellId: `סייר6שעות_${day}_${shift}`,
                        type: 'patrol',
                        isNight: shift === 0,
                        hours: 6
                    });
                }
            }
            
            // Add 4 hour shifts
            for (let day = 0; day < 7; day++) {
                allShifts.push({ 
                    day, 
                    shift: 'all', 
                    cellId: `סייר4שעות_${day}_all`,
                    type: 'short',
                    isNight: false,
                    hours: 4
                });
            }
            
            // Shuffle shifts
            allShifts.sort(() => Math.random() - 0.5);
            
            // Assign shifts
            allShifts.forEach(shiftSlot => {
                const availableEmployees = selectedEmployees.filter(emp => {
                    const tracker = employeeTracker[emp.id];
                    
                    if (shiftSlot.type === 'short' && tracker.shortShifts >= maxShortShifts) return false;
                    if (shiftSlot.type !== 'short' && tracker.regularShifts >= maxRegularShifts) return false;
                    if (tracker.assignedDays.has(shiftSlot.day)) return false;
                    if (systemSettings.preventConsecutive && Math.abs(tracker.lastAssignedDay - shiftSlot.day) <= 1 && tracker.lastAssignedDay !== -2) return false;
                    if (shiftSlot.isNight && tracker.nightShifts >= systemSettings.maxNightShifts) return false;
                    
                    const empAvailability = availabilityData[emp.id];
                    if (empAvailability && empAvailability.unavailable && shiftSlot.shift !== 'all') {
                        const isUnavailable = empAvailability.unavailable.some(slot => 
                            slot.day === shiftSlot.day && slot.shift === shiftSlot.shift
                        );
                        if (isUnavailable) return false;
                    }
                    
                    return true;
                });

                if (availableEmployees.length > 0) {
                    const selectedEmp = availableEmployees.reduce((prev, current) => {
                        const prevTracker = employeeTracker[prev.id];
                        const currentTracker = employeeTracker[current.id];
                        const prevTotal = (prevTracker.regularShifts * 6) + (prevTracker.shortShifts * 4);
                        const currentTotal = (currentTracker.regularShifts * 6) + (currentTracker.shortShifts * 4);
                        return prevTotal < currentTotal ? prev : current;
                    });
                    
                    assignShiftToEmployee(shiftSlot.cellId, selectedEmp, employeeTracker[selectedEmp.id], shiftSlot.day, shiftSlot.type === 'short', shiftSlot.isNight);
                }
            });
        }

        function generateScheduleSummary(employeeTracker) {
            let sgShifts = 0;
            let patrolShifts = 0;
            let shortShifts = 0;
            let assignedEmployees = 0;
            let totalNightShifts = 0;

            Object.keys(scheduleData).forEach(cellId => {
                if (cellId.startsWith('ש.ג')) {
                    sgShifts++;
                    if (cellId.includes('_0')) totalNightShifts++;
                } else if (cellId.includes('6שעות')) {
                    patrolShifts++;
                    if (cellId.includes('_0')) totalNightShifts++;
                } else if (cellId.includes('4שעות')) {
                    shortShifts++;
                }
            });

            Object.values(employeeTracker).forEach(tracker => {
                if (tracker.regularShifts > 0 || tracker.shortShifts > 0) {
                    assignedEmployees++;
                }
            });

            const totalPossibleShifts = 28 + 28 + 7;
            const totalAssigned = sgShifts + patrolShifts + shortShifts;
            const coveragePercent = Math.round((totalAssigned / totalPossibleShifts) * 100);

            return { sgShifts, patrolShifts, shortShifts, assignedEmployees, coveragePercent, totalNightShifts };
        }

        function clearAllSchedule() {
            if (!confirm('האם למחוק את כל השיבוץ?')) return;
            scheduleData = {};
            generateScheduleTable();
            alert('לוח המשמרות נוקה');
        }

        function exportSchedule() {
            alert('יצוא לאקסל יהיה זמין בגירסה עתידית');
        }

        function highlightMyShifts() {
            if (!currentUser) return;
            
            const myName = `${currentUser.firstName} ${currentUser.lastName}`;
            Object.keys(scheduleData).forEach(cellId => {
                if (scheduleData[cellId] === myName) {
                    const cell = document.getElementById(cellId);
                    if (cell) {
                        cell.classList.add('my-shift');
                    }
                }
            });
        }

        // Settings Functions
        function updateRangeValue(settingName, value) {
            document.getElementById(settingName + 'Value').textContent = value;
            
            // Update employees range max based on available employees
            if (settingName === 'maxEmployeesToSchedule') {
                const employees = users.filter(u => u.type === 'חייל');
                const maxRange = document.getElementById('maxEmployeesToSchedule');
                maxRange.max = Math.max(employees.length, 1);
            }
        }

        function saveSettings() {
            systemSettings.maxEmployeesToSchedule = parseInt(document.getElementById('maxEmployeesToSchedule').value);
            systemSettings.shiftsPerEmployee = parseInt(document.getElementById('shiftsPerEmployee').value);
            systemSettings.shortShiftsPerEmployee = parseInt(document.getElementById('shortShiftsPerEmployee').value);
            systemSettings.maxNightShifts = parseInt(document.getElementById('maxNightShifts').value);
            systemSettings.assignmentPriority = document.getElementById('assignmentPriority').value;
            systemSettings.preventConsecutive = document.getElementById('preventConsecutive').checked;
            
            alert('🎯 הגדרות נשמרו בהצלחה!\n\nההגדרות החדשות יופעלו בשיבוץ האוטומטי הבא.');
            console.log('Settings saved:', systemSettings);
        }

        function savePermissions() {
            systemSettings.availabilityOpen = document.getElementById('availabilityOpen').checked;
            systemSettings.statsVisible = document.getElementById('statsVisible').checked;
            
            // Update availability message
            const availabilityTab = document.getElementById('availabilityTab');
            if (systemSettings.availabilityOpen) {
                availabilityTab.innerHTML = `
                    <h2>⏰ זמינות למשמרות</h2>
                    <div class="alert alert-success">מילוי זמינות פתוח! חיילים יכולים למלא את הזמינות שלהם.</div>
                `;
            } else {
                availabilityTab.innerHTML = `
                    <h2>⏰ זמינות למשמרות</h2>
                    <div class="alert alert-info">מילוי זמינות סגור כרגע. יפתח על ידי המנהל.</div>
                `;
            }
            
            // Update stats visibility
            updateUserInterface();
            
            alert('🔐 הרשאות עודכנו בהצלחה!');
            console.log('Permissions saved:', { availabilityOpen: systemSettings.availabilityOpen, statsVisible: systemSettings.statsVisible });
        }

        function updateSettingsDisplay() {
            // Update employees range max
            const employees = users.filter(u => u.type === 'חייל');
            const maxRange = document.getElementById('maxEmployeesToSchedule');
            maxRange.max = Math.max(employees.length, 1);
            
            // Set current values
            document.getElementById('maxEmployeesToSchedule').value = systemSettings.maxEmployeesToSchedule;
            document.getElementById('shiftsPerEmployee').value = systemSettings.shiftsPerEmployee;
            document.getElementById('shortShiftsPerEmployee').value = systemSettings.shortShiftsPerEmployee;
            document.getElementById('maxNightShifts').value = systemSettings.maxNightShifts;
            document.getElementById('assignmentPriority').value = systemSettings.assignmentPriority;
            document.getElementById('preventConsecutive').checked = systemSettings.preventConsecutive;
            document.getElementById('availabilityOpen').checked = systemSettings.availabilityOpen;
            document.getElementById('statsVisible').checked = systemSettings.statsVisible;
            
            // Update range value displays
            updateRangeValue('maxEmployeesToSchedule', systemSettings.maxEmployeesToSchedule);
            updateRangeValue('shiftsPerEmployee', systemSettings.shiftsPerEmployee);
            updateRangeValue('shortShiftsPerEmployee', systemSettings.shortShiftsPerEmployee);
            updateRangeValue('maxNightShifts', systemSettings.maxNightShifts);
        }

        // Helper functions
        function getHebrewDate(gregorianDate) {
            const year = gregorianDate.getFullYear();
            const month = gregorianDate.getMonth();
            const day = gregorianDate.getDate();
            
            const hebrewYear = year + 3760 + (month >= 8 ? 1 : 0);
            
            let hebrewMonthIndex;
            if (month >= 8) {
                hebrewMonthIndex = month - 8;
            } else {
                hebrewMonthIndex = month + 4;
            }
            
            const hebrewMonth = hebrewMonths[hebrewMonthIndex];
            const hebrewDay = hebrewNumerals[Math.min(day, 30)] || day.toString();
            
            return {
                day: hebrewDay,
                month: hebrewMonth,
                year: hebrewYear,
                fullDate: `${hebrewDay} ${hebrewMonth}`
            };
        }

        function showDashboard() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            const userInfo = document.getElementById('userInfoDisplay');
            const userTypeText = {
                'admin': 'מנהל כללי',
                'מנהל': 'מנהל',
                'חייל': 'חייל',
                'viewer': 'צופה'
            };
            
            userInfo.innerHTML = `ברוך הבא ${currentUser.firstName} ${currentUser.lastName}${userTypeText[currentUser.type] ? ` | ${userTypeText[currentUser.type]}` : ''} | טלפון: ${currentUser.phone}`;
            
            // Generate schedule table
            generateScheduleTable();
            
            alert(`התחברת בהצלחה למערכת${userTypeText[currentUser.type] ? ` כ${userTypeText[currentUser.type]}` : ''}!`);
        }

        function setupUserInterface() {
            const isAdmin = currentUser.type === 'admin';
            const isManager = currentUser.type === 'מנהל' || isAdmin;
            const isEmployee = currentUser.type === 'חייל';
            
            // Show/hide tabs based on permissions
            document.getElementById('availabilityTabBtn').style.display = isEmployee ? 'block' : 'none';
            document.getElementById('statsTabBtn').style.display = (isManager && systemSettings.statsVisible) ? 'block' : 'none';
            document.getElementById('managementTabBtn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('reportsTabBtn').style.display = isManager ? 'block' : 'none';
            document.getElementById('settingsTabBtn').style.display = isAdmin ? 'block' : 'none';

            // Show/hide manager buttons
            const managerButtons = document.getElementById('managerButtons');
            if (managerButtons) {
                managerButtons.style.display = isManager ? 'block' : 'none';
            }

            updateUsersList();
            updateStats();
            
            // Update settings display if admin
            if (isAdmin) {
                updateSettingsDisplay();
                updateEmployeeAvailabilityDropdown();
            }
            
            // Update availability content
            if (isEmployee) {
                updateAvailabilityContent();
            }
            
            // Highlight user's shifts
            setTimeout(() => {
                highlightMyShifts();
            }, 100);
        }

        function generateScheduleTable() {
            const container = document.getElementById('scheduleTableContainer');
            const today = new Date();
            const currentWeekStart = new Date(today.setDate(today.getDate() - today.getDay()));

            let html = '<table class="schedule-table"><thead><tr><th rowspan="3">תפקיד</th>';

            // Generate week headers
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                
                const dayName = dayNames[i];
                const gregorianDate = `${date.getDate()}/${date.getMonth() + 1}`;
                const hebrewDate = getHebrewDate(date);
                const dateKey = date.toISOString().split('T')[0];
                const isHoliday = jewishHolidays[dateKey];
                const isShabbat = i === 6;

                let headerClass = '';
                if (isHoliday) headerClass = 'holiday';
                else if (isShabbat) headerClass = 'shabbat';

                html += `<th colspan="4" class="${headerClass}" style="border: 2px solid #dee2e6;">
                    <div style="font-weight: 700; font-size: 1.1em;">${dayName}</div>
                    <div style="font-size: 0.9em; margin: 3px 0;">${gregorianDate}</div>
                    <div class="hebrew-date" style="font-size: 0.85em; font-weight: 600; color: #7b1fa2; margin: 2px 0;">${hebrewDate.fullDate}</div>
                    ${isHoliday ? `<div style="font-size: 0.7em; color: #01579b; font-weight: 600;">${isHoliday}</div>` : ''}
                    ${isShabbat && !isHoliday ? `<div style="font-size: 0.7em; color: #880e4f; font-weight: 600;">שבת קודש</div>` : ''}
                </th>`;
            }

            html += '</tr><tr>';

            // Generate shift time headers
            for (let i = 0; i < 7; i++) {
                for (let j = 0; j < 4; j++) {
                    html += `<th style="font-size: 10px; padding: 5px;">${shiftTypes[j]}<br><small>${shiftTimes[j]}</small></th>`;
                }
            }

            html += '</tr></thead><tbody>';

            // Generate role rows
            const roles = [
                { name: 'ש.ג', class: 'role-sg', shifts: 4 },
                { name: 'סייר 6 שעות', class: 'role-patrol', shifts: 4 },
                { name: 'סייר 4 שעות', class: 'role-patrol-4h', shifts: 1 }
            ];

            roles.forEach(role => {
                html += `<tr><td class="${role.class}" style="font-weight: 700; text-align: center;">${role.name}</td>`;
                
                for (let day = 0; day < 7; day++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(currentWeekStart.getDate() + day);
                    const dateKey = date.toISOString().split('T')[0];
                    const isHoliday = jewishHolidays[dateKey];
                    const isShabbat = day === 6;

                    if (role.shifts === 1) {
                        const cellId = `${role.name.replace(/\s+/g, '')}_${day}_all`;
                        let cellClasses = `shift-cell ${role.class}`;
                        if (isHoliday) cellClasses += ' holiday';
                        else if (isShabbat) cellClasses += ' shabbat';
                        
                        const assignedEmployee = scheduleData[cellId];
                        const cellContent = assignedEmployee ? assignedEmployee.replace(' ', '<br>') : '';
                        const isAssigned = assignedEmployee ? 'assigned' : '';
                        const isMyShift = (currentUser && assignedEmployee === `${currentUser.firstName} ${currentUser.lastName}`) ? 'my-shift' : '';
                        
                        html += `<td colspan="4" class="${cellClasses} ${isAssigned} ${isMyShift}" id="${cellId}">${cellContent}</td>`;
                    } else {
                        for (let shift = 0; shift < 4; shift++) {
                            const cellId = `${role.name.replace(/\s+/g, '')}_${day}_${shift}`;
                            const isNight = shift === 0;
                            let cellClasses = `shift-cell ${role.class}`;
                            if (isNight) cellClasses += ' night';
                            if (isHoliday) cellClasses += ' holiday';
                            else if (isShabbat) cellClasses += ' shabbat';
                            
                            const assignedEmployee = scheduleData[cellId];
                            const cellContent = assignedEmployee ? assignedEmployee.replace(' ', '<br>') : '';
                            const isAssigned = assignedEmployee ? 'assigned' : '';
                            const isMyShift = (currentUser && assignedEmployee === `${currentUser.firstName} ${currentUser.lastName}`) ? 'my-shift' : '';
                            
                            html += `<td class="${cellClasses} ${isAssigned} ${isMyShift}" id="${cellId}">${cellContent}</td>`;
                        }
                    }
                }
                
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Re-highlight my shifts after table generation
            setTimeout(() => {
                highlightMyShifts();
            }, 100);
        }

        function updateUsersList() {
            const container = document.getElementById('usersList');
            
            if (users.length <= 1) {
                container.innerHTML = '<div class="alert alert-info">רק המנהל הכללי קיים במערכת. הוסף משתמשים כדי להתחיל.</div>';
                return;
            }

            const typeText = {
                'חייל': 'חייל',
                'viewer': 'צופה',
                'מנהל': 'מנהל',
                'admin': 'מנהל כללי'
            };

            let html = '';
            users.forEach(user => {
                if (currentUser && currentUser.type === 'חייל' && (user.type === 'admin' || user.type === 'מנהל')) {
                    return;
                }

                html += `
                    <div class="user-item">
                        <div class="user-info-item">
                            <div class="user-name">${user.firstName} ${user.lastName}</div>
                            <div class="user-details">טלפון: ${user.phone}${typeText[user.type] ? ` | סוג: ${typeText[user.type]}` : ''}${user.email ? ` | אימייל: ${user.email}` : ''}</div>
                        </div>
                        ${currentUser && currentUser.type === 'admin' && user.id !== currentUser.id ? 
                            `<button class="btn btn-danger" onclick="removeUser(${user.id})">הסר</button>` : 
                            ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateQuickLoginOptions() {
            const quickLogin = document.getElementById('quickLogin');
            if (!quickLogin) return;

            const currentSelection = quickLogin.value;
            
            quickLogin.innerHTML = `
                <option value="">בחר משתמש...</option>
                <option value="admin">מנהל כללי</option>
                <option value="manual">כניסה ידנית</option>
            `;

            users.forEach(user => {
                if (user.type !== 'admin') {
                    const typeText = {
                        'חייל': 'חייל',
                        'viewer': 'צופה',
                        'מנהל': 'מנהל'
                    };
                    
                    const option = document.createElement('option');
                    option.value = `user_${user.id}`;
                    option.textContent = `${user.firstName} ${user.lastName}${typeText[user.type] ? ` (${typeText[user.type]})` : ''}`;
                    quickLogin.appendChild(option);
                }
            });

            quickLogin.value = currentSelection;
        }

        function updateStats() {
            const container = document.getElementById('statsGrid');
            const employees = users.filter(u => u.type === 'חייל');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="alert alert-info">אין חיילים במערכת לחישוב סטטיסטיקות</div>';
                return;
            }

            const stats = calculateAdvancedScheduleStats();
            
            let html = `
                <div class="stat-card">
                    <div class="stat-number">${users.length}</div>
                    <div class="stat-label">סה"כ משתמשים</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${employees.length}</div>
                    <div class="stat-label">חיילים פעילים</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalShifts}</div>
                    <div class="stat-label">סה"כ משמרות מאוישות</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.sgCoverage}%</div>
                    <div class="stat-label">כיסוי ש.ג</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.patrolCoverage}%</div>
                    <div class="stat-label">כיסוי סיור 6 שעות</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.shortCoverage}%</div>
                    <div class="stat-label">כיסוי סיור 4 שעות</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.averageHours}</div>
                    <div class="stat-label">ממוצע שעות לחייל</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.nightShiftBalance}%</div>
                    <div class="stat-label">איזון משמרות לילה</div>
                </div>
            `;

            // Individual employee stats
            if (currentUser && (currentUser.type === 'admin' || currentUser.type === 'מנהל')) {
                employees.forEach(emp => {
                    const empStats = calculateAdvancedEmployeeStats(emp);
                    const targetHours = systemSettings.shiftsPerEmployee * 6 + systemSettings.shortShiftsPerEmployee * 4;
                    const efficiency = targetHours > 0 ? Math.round((empStats.totalHours / targetHours) * 100) : 0;
                    const efficiencyColor = efficiency >= 90 ? '#56ab2f' : efficiency >= 70 ? '#f39c12' : '#e74c3c';

                    html += `
                        <div class="stat-card">
                            <h4 style="margin-bottom: 10px; color: #2c3e50;">${emp.firstName} ${emp.lastName}</h4>
                            <div style="font-size: 0.9em; color: #7f8c8d;">
                                <div>משמרות 6 שעות: <strong>${empStats.regularShifts}</strong>/${systemSettings.shiftsPerEmployee}</div>
                                <div>משמרות 4 שעות: <strong>${empStats.shortShifts}</strong>/${systemSettings.shortShiftsPerEmployee}</div>
                                <div>משמרות לילה: <strong>${empStats.nightShifts}</strong>/${systemSettings.maxNightShifts}</div>
                                <div>סה"כ שעות: <strong>${empStats.totalHours}</strong>/${targetHours}</div>
                                <div style="color: ${efficiencyColor}; font-weight: 700;">יעילות: ${efficiency}%</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${Math.min(efficiency, 100)}%; background: ${efficiencyColor};"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function calculateAdvancedScheduleStats() {
            const totalShifts = Object.keys(scheduleData).length;
            const sgShifts = Object.keys(scheduleData).filter(key => key.startsWith('ש.ג')).length;
            const patrolShifts = Object.keys(scheduleData).filter(key => key.includes('6שעות')).length;
            const shortShifts = Object.keys(scheduleData).filter(key => key.includes('4שעות')).length;
            const nightShifts = Object.keys(scheduleData).filter(key => key.includes('_0')).length;
            
            const sgCoverage = Math.round((sgShifts / 28) * 100);
            const patrolCoverage = Math.round((patrolShifts / 28) * 100);
            const shortCoverage = Math.round((shortShifts / 7) * 100);
            
            const employees = users.filter(u => u.type === 'חייל');
            const totalPossibleHours = employees.length * (systemSettings.shiftsPerEmployee * 6 + systemSettings.shortShiftsPerEmployee * 4);
            const actualHours = (sgShifts + patrolShifts) * 6 + shortShifts * 4;
            const averageHours = employees.length > 0 ? Math.round(actualHours / employees.length) : 0;
            
            const expectedNightShifts = employees.length * systemSettings.maxNightShifts;
            const nightShiftBalance = expectedNightShifts > 0 ? Math.round((nightShifts / expectedNightShifts) * 100) : 100;

            return { 
                totalShifts, 
                sgCoverage, 
                patrolCoverage, 
                shortCoverage,
                averageHours, 
                nightShiftBalance,
                actualHours,
                totalPossibleHours
            };
        }

        function calculateAdvancedEmployeeStats(employee) {
            const employeeName = `${employee.firstName} ${employee.lastName}`;
            let regularShifts = 0;
            let shortShifts = 0;
            let nightShifts = 0;
            let sgShifts = 0;
            let patrolShifts = 0;

            Object.keys(scheduleData).forEach(cellId => {
                if (scheduleData[cellId] === employeeName) {
                    if (cellId.includes('4שעות')) {
                        shortShifts++;
                    } else {
                        regularShifts++;
                        if (cellId.startsWith('ש.ג')) {
                            sgShifts++;
                        } else {
                            patrolShifts++;
                        }
                        if (cellId.includes('_0')) {
                            nightShifts++;
                        }
                    }
                }
            });

            const totalHours = (regularShifts * 6) + (shortShifts * 4);
            const targetHours = systemSettings.shiftsPerEmployee * 6 + systemSettings.shortShiftsPerEmployee * 4;
            const workload = targetHours > 0 ? Math.round((totalHours / targetHours) * 100) : 0;

            return { 
                regularShifts, 
                shortShifts, 
                nightShifts, 
                sgShifts,
                patrolShifts,
                totalHours,
                workload
            };
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 מערכת ניהול משמרות מתקדמת נטענת...');
            updateQuickLoginOptions();
            console.log('✅ מערכת מוכנה לשימוש');
            console.log('מנהל כללי: מנהל כללי (0585123770) | סיסמה: 322770');
        });
    
function updateEmployeeAvailabilityDropdown() {
    // פונקציה ריקה כדי למנוע שגיאה
}

function updateAvailabilityProgress() {
    const employees = users.filter(u => u.type === 'חייל');
    const total = employees.length;
    let completed = 0;

    employees.forEach(emp => {
        const av = availabilityData[emp.id];
        if (av && av.submitted) completed++;
    });

    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
    const fill = document.getElementById('availabilityProgressFill');
    const text = document.getElementById('availabilityProgressText');
    if (fill) fill.style.width = percent + '%';
    if (text) text.textContent = percent + '% השלימו';

    if (percent === 100) {
        alert('🎉 כל החיילים השלימו את מילוי הזמינות!');
    }
}


let scheduledAvailability = null;

function scheduleAvailabilityOpening() {
    const day = parseInt(document.getElementById('availabilityDay').value);
    const hour = document.getElementById('availabilityHour').value;

    scheduledAvailability = { day, hour };
    document.getElementById('availabilityScheduleInfo').textContent =
        `📅 מילוי זמינות יפתח ביום ${dayNames[day]} בשעה ${hour}`;

    alert('🕓 זמינות תיפתח במועד שנבחר.');
}

// check every minute if we need to open availability
setInterval(() => {
    if (!scheduledAvailability) return;

    const now = new Date();
    const nowDay = now.getDay();
    const nowHour = now.getHours().toString().padStart(2, '0') + ':' +
                    now.getMinutes().toString().padStart(2, '0');

    if (nowDay === scheduledAvailability.day && nowHour >= scheduledAvailability.hour) {
        systemSettings.availabilityOpen = true;
        scheduledAvailability = null;
        alert('✅ מילוי זמינות נפתח אוטומטית כמתוכנן!');
        updateAvailabilityContent();
    }
}, 60000);


function clearUserForm() {
    document.getElementById('newFirstName').value = '';
    document.getElementById('newLastName').value = '';
    document.getElementById('newPhone').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newType').value = '';
    console.log("🧼 טופס נוקה");
}

function addUser() {
    const firstNameInput = document.getElementById('newFirstName');
    const lastNameInput = document.getElementById('newLastName');
    const phoneInput = document.getElementById('newPhone');
    const passwordInput = document.getElementById('newPassword');
    const typeInput = document.getElementById('newType');

    const firstName = firstNameInput?.value.trim();
    const lastName = lastNameInput?.value.trim();
    const phone = phoneInput?.value.trim();
    const password = passwordInput?.value.trim();
    const type = typeInput?.value.trim();

    if (!firstName || !lastName || !phone || !password || !type) {
        alert("יש למלא את כל השדות");
        return;
    }

    const id = Date.now();
    const newUser = { id, firstName, lastName, phone, password, type };
    users.push(newUser);
    populateSoldierTable();
    saveUsersToStorage();
    updateUsersList();

    alert((type === 'admin' || type === 'מנהל') ? 'מנהל נוסף בהצלחה למערכת' : 'חייל נוסף בהצלחה למערכת');
    clearUserForm();
}



function openAvailabilityForSelected() {
    const select = document.getElementById("availabilityUserSelect");
    const selectedIds = Array.from(select.selectedOptions).map(opt => opt.value);
    localStorage.setItem("availabilityAllowedUsers", JSON.stringify(selectedIds));
    alert("הזמינות נפתחה לחיילים שנבחרו.");
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (user && selectedIds.includes(user.id.toString())) {
        document.getElementById("availabilitySection").style.display = "block";
        document.getElementById("availabilityClosedMessage").style.display = "none";
    }
}
function isAvailabilityOpenForUser(userId) {
    const allowed = JSON.parse(localStorage.getItem("availabilityAllowedUsers") || "[]");
    return allowed.includes(userId);
}

function populateAvailabilityUserSelect() {
    const select = document.getElementById("availabilityUserSelect");
    if (!select) return;
    const users = JSON.parse(localStorage.getItem("users") || "[]");
    select.innerHTML = "";
    users.forEach(user => {
        if (user.type === "חייל") {
            const opt = document.createElement("option");
            opt.value = user.id;
            opt.textContent = user.firstName + " " + user.lastName;
            select.appendChild(opt);
        }
    });
}

window.onload = function() {
    const user = JSON.parse(localStorage.getItem('loggedInUser'));
    if (user) {
        loadAvailabilityForUser(user.id);
        if (isAvailabilityOpenForUser(user.id)) {
            document.getElementById("availabilitySection").style.display = "block";
            document.getElementById("availabilityClosedMessage").style.display = "none";
        } else {
            document.getElementById("availabilitySection").style.display = "none";
            document.getElementById("availabilityClosedMessage").style.display = "block";
        }
    }
    populateAvailabilityUserSelect();
  populateSoldierTable();
};


function openAvailabilityNow() {
    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    if (!user) {
        alert("אין משתמש מחובר.");
        return;
    }
    const allowed = JSON.parse(localStorage.getItem("availabilityAllowedUsers") || "[]");
    if (!allowed.includes(user.id)) {
        allowed.push(user.id);
        localStorage.setItem("availabilityAllowedUsers", JSON.stringify(allowed));
    }
    document.getElementById("availabilitySection").style.display = "block";
    document.getElementById("availabilityClosedMessage").style.display = "none";
    alert("הטופס נפתח עבור החייל המחובר.");
}


function updateSoldierCount() {
  try {
    const users = JSON.parse(localStorage.getItem("users") || "[]");
    const soldierCount = users.filter(u => u.type === "חייל").length;
    const counter = document.getElementById("soldierCountDisplay");
    if (counter) {
      counter.textContent = "חיילים במערכת: " + soldierCount;
    }
  } catch (e) {
    console.error("שגיאה בספירת חיילים:", e);
  }
}

if (typeof window.onload === 'function') {
  const prevOnLoad = window.onload;
  window.onload = function() {
    prevOnLoad();
    updateSoldierCount();
  };
} else {
  window.onload = function() {
    updateSoldierCount();
  };
}


function populateSoldierTable() {
  const users = JSON.parse(localStorage.getItem("users") || "[]");
  const soldiers = users.filter(u => u.type === "חייל");
  const tbody = document.querySelector("#soldierTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  soldiers.forEach((soldier, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `<td>${index + 1}</td><td>${soldier.firstName}</td><td>${soldier.lastName}</td>`;
    tbody.appendChild(row);
  });
}

</script>
</body>
</html>